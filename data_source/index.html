<!DOCTYPE html>
<html>

<head>
  <meta charset="UTF-8">
  <title>ESP32 –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è</title>
  <style>
      body {
          font-family: sans-serif;
          padding: 20px;
          background-color: #f4f4f4;
      }

      h2 {
          background: #444;
          color: white;
          padding: 10px;
          margin: 0;
      }

      .section {
          background: white;
          padding: 15px;
          border-radius: 5px;
      }

      label {
          display: block;
          margin: 10px 0 5px;
      }

      input,
      select,
      button {
          padding: 5px;
          font-size: 14px;
          width: 100%;
          max-width: 200px;
          margin-bottom: 10px;
      }

      input[type="checkbox"] {
          width: auto;
      }

      input[type="color"] {
          width: 50px;
          height: 30px;
          border: none;
          padding: 0;
          margin: 0;
      }

      table {
          border-collapse: collapse;
          margin-bottom: 10px;
      }

      th,
      td {
          border: 1px solid #ccc;
          padding: 6px;
          text-align: left;
      }

      #actionSelect {
          display: flex;
          flex-wrap: wrap;
          gap: 20px;
      }

      #actionSelect label {
          display: flex;
          align-items: center;
      }

      td select,
      td input {
          width: 100%;
          margin: 0;
          box-sizing: border-box;
      }

      tr td {
          padding: 0;
      }

      tr td.btnIndex {
          width: 20px;
          padding: 5px;
      }

      tr td.btnToDo {
          width: 80px;
          padding: 5px 10px;
      }

      .layout-preview {
          position: relative;
          width: 400px;
          height: 600px;
          background: #f0f0f0;
          border: 1px solid #aaa;
          margin-top: 15px;
          border-radius: 5px;
      }

      .layout-preview.hidden {
          display: none;
      }

      .layout-element {
          position: absolute;
          box-sizing: border-box;
          background: #ccc;
          border-radius: 5px;
      }

      .layout-button {
          cursor: pointer;
          transition: outline 0.2s, transform 0.2s;
      }

      .layout-button:hover {
          transform: scale(1.05);
          z-index: 10;
      }

      .layout_editor {
          display: none;
          margin-top: 10px;
      }

      .layout_editor.active {
          display: block;
      }

      .layout-edit-btn {
          position: absolute;
          top: 65px;
          right: 5px;
          z-index: 20;
          background: #444;
          color: white;
          border: none;
          padding: 5px 10px;
          font-size: 12px;
          border-radius: 3px;
          cursor: pointer;
          opacity: 0.8;
      }

      .layout-edit-btn:hover {
          opacity: 1;
      }

      .bnt_wrapper {
          display: flex;
          gap: 20px;
      }

      #layout-section {
          position: relative;
      }

      .section .section_body {
          max-height: 0;
          overflow: hidden;
          transition: max-height 0.3s linear;
      }

      .section .section_body.open {
          max-height: 3000px;
          transition: max-height 0.3s linear;
      }

      .section h2 {
          cursor: pointer;
          transition: background 0.3s;
      }

      .section h2:hover {
          background: #999;
      }

      .section h2:after {
          content: ' ‚ñº';
          font-size: 0.8em;
          color: #666;
          transition: transform 0.3s;
          float: right;
      }

      .section.open h2:after {
          transform: rotate(180deg);
      }

      #msg_wrapper {
          position: absolute;
          display: flex;
          top: 10px;
          right: 50%;
          transform: translateX(50%);
          z-index: 1000;
          width: 250px;
      }

      .alert_message {
          background: #fff6db;
          color: #bb7300;
          padding: 10px;
          border-radius: 5px;
          margin-bottom: 10px;
          font-size: 14px;
          width: 100%;
          text-align: center;
          transition: opacity 0.3s ease-in-out;
          box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
      }

      #infoContent table {
          border-collapse: collapse;
          margin: 10px 0;
          background: #fff;
      }

      #infoContent th,
      #infoContent td {
          border: 1px solid #ccc;
          padding: 0px 8px;
      }

      #infoContent th {
          background: #eee;
      }

      #infoContent h3 {
          margin-top: 15px;
          background: #444;
          color: #fff;
          padding: 5px 10px;
          border-radius: 3px;
      }

      h2 button {
          margin-bottom: 0;
      }

      table button {
          margin-bottom: 0;
      }
  </style>
</head>

<body>
<h1>–ù–∞—Å—Ç—Ä–æ–π–∫–∏ ESP32</h1>
<datalist id="color_list">
  <!-- –û—Å–Ω–æ–≤–Ω—ã–µ —á–∏—Å—Ç—ã–µ —Ü–≤–µ—Ç–∞ -->
  <option>#ff0000</option> <!-- –ö—Ä–∞—Å–Ω—ã–π -->
  <option>#00ff00</option> <!-- –ó–µ–ª—ë–Ω—ã–π -->
  <option>#0000ff</option> <!-- –°–∏–Ω–∏–π -->
  <option>#ffff00</option> <!-- –ñ—ë–ª—Ç—ã–π -->
  <option>#00ffff</option> <!-- –ì–æ–ª—É–±–æ–π -->
  <option>#ff00ff</option> <!-- –ü—É—Ä–ø—É—Ä–Ω—ã–π -->
  <option>#ffffff</option> <!-- –ë–µ–ª—ã–π -->

  <!-- –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —è—Ä–∫–∏–µ -->
  <option>#ff8000</option> <!-- –û—Ä–∞–Ω–∂–µ–≤—ã–π -->
  <option>#ff0080</option> <!-- –†–æ–∑–æ–≤—ã–π -->
  <option>#80ff00</option> <!-- –Ø—Ä–∫–æ-—Å–∞–ª–∞—Ç–æ–≤—ã–π -->
  <option>#00ff80</option> <!-- –ú—è—Ç–Ω—ã–π -->
  <option>#0080ff</option> <!-- –ù–µ–±–µ—Å–Ω–æ-—Å–∏–Ω–∏–π -->
  <option>#8000ff</option> <!-- –§–∏–æ–ª–µ—Ç–æ–≤—ã–π -->
  <option>#ff0040</option> <!-- –ú–∞–ª–∏–Ω–æ–≤—ã–π -->

  <!-- –¢–µ–º–Ω—ã–µ –Ω–∞—Å—ã—â–µ–Ω–Ω—ã–µ –æ—Ç—Ç–µ–Ω–∫–∏ –¥–ª—è –∫–æ–Ω—Ç—Ä–∞—Å—Ç–∞ -->
  <option>#800000</option> <!-- –¢—ë–º–Ω–æ-–∫—Ä–∞—Å–Ω—ã–π -->
  <option>#008000</option> <!-- –¢—ë–º–Ω–æ-–∑–µ–ª—ë–Ω—ã–π -->
  <option>#000080</option> <!-- –¢—ë–º–Ω–æ-—Å–∏–Ω–∏–π -->
</datalist>

<div id="msg_wrapper">
</div>
<div class="section" id="wifi-section">
  <h2><a href="/wifi.bin" target="_blank">Wi-Fi</a></h2>
  <div class="section_body">
    <label for="ssid">SSID</label>
    <input type="text" id="ssid">
    <label for="password">–ü–∞—Ä–æ–ª—å</label>
    <input type="text" id="password">
    <label for="mode">–†–µ–∂–∏–º</label>
    <select id="mode">
      <option value="0">STA</option>
      <option value="1">AP</option>
    </select>
    <button onclick="saveWiFi()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å Wi-Fi</button>
  </div>
</div>

<div class="section" id="info-section">
  <h2>–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ–± —É—Å—Ç—Ä–æ–π—Å—Ç–≤–µ
    <button onclick="loadInfo()">üîÑ –û–±–Ω–æ–≤–∏—Ç—å</button>
  </h2>
  <div class="section_body">
    <div id="infoContent"></div>
  </div>
</div>

<div class="section" id="buttons-section">
  <h2><a href="/config.bin" target="_blank">–ö–Ω–æ–ø–∫–∏</a> –∏ <a href="/color.bin" target="_blank">—Ü–≤–µ—Ç–∞</a></h2>
  <div class="section_body open">
    <div id="colorSelect">
      <input name="index" value="0" id="colorInput" type="number" min="0" max="255"/>
      <input name="color" value="#FF8800" type="color" list="color_list" id="colorInputColor"/>
      <button onclick="testColor()">Test</button>
    </div>

    <label for="layerSelect">–°–ª–æ–π:</label>
    <select id="layerSelect" onchange="renderButtonConfig()"></select>
    <div class="bnt_wrapper">
      <div id="actionsContainer">
        <h3>–î–µ–π—Å—Ç–≤–∏—è:</h3>
        <div id="actionSelect"></div>
        <div id="buttonsTableContainer"></div>
        <button onclick="saveButtons()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∫–Ω–æ–ø–∫–∏</button>
      </div>

      <div id="layout-section">
        <h3>–í–∏–∑—É–∞–ª—å–Ω–æ–µ —Ä–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∏–µ –∫–Ω–æ–ø–æ–∫</h3>
        <div id="layoutPreview" class="layout-preview"></div>
        <button class="layout-edit-btn" onclick="showLayoutEditor()">–ò–∑–º–µ–Ω–∏—Ç—å</button>
        <div class="layout_editor" id="layoutEditor">
          <textarea id="layoutText" rows="5" style="width:100%; font-family:monospace;"></textarea>
          <button onclick="saveLayout(true)">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Å—Ö–µ–º—É + –ø—Ä–∏–º–µ–Ω–∏—Ç—å</button>
          <button onclick="cancelLayout()">–û—Ç–º–µ–Ω–∞</button>
        </div>
      </div>

    </div>
  </div>
</div>

<div class="section" id="ir-section">
  <h2>IR-–∫–æ–¥—ã</h2>
  <div class="section_body">
    <table id="irTable">
      <thead>
      <tr>
        <th>#</th>
        <th>–°–ª–æ—Ç</th>
        <th>–ò–º—è</th>
        <th>–ß–∞—Å—Ç–æ—Ç–∞</th>
        <th>–ö–æ–¥</th>
        <th colspan="4">–î–µ–π—Å—Ç–≤–∏—è</th>
      </tr>
      </thead>
      <tbody></tbody>
    </table>
    <button onclick="addIRCode()">–î–æ–±–∞–≤–∏—Ç—å IR-–∫–æ–¥</button>
  </div>
</div>

<div class="section" id="scripts-section">
  <h2>–°–∫—Ä–∏–ø—Ç—ã</h2>
  <div class="section_body">
    <div>
      <label for="scriptList">–°–ø–∏—Å–æ–∫ —Å–∫—Ä–∏–ø—Ç–æ–≤:</label>
      <select id="scriptList" onchange="loadScriptEditor()">
        <option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ —Å–∫—Ä–∏–ø—Ç --</option>
      </select>
      <button onclick="downloadScript()">‚Üì –°–∫–∞—á–∞—Ç—å</button>
      <button onclick="deleteScript()">‚úñ –£–¥–∞–ª–∏—Ç—å</button>
    </div>

    <div style="margin-top:10px">
      <label for="scriptName">–ù–∞–∑–≤–∞–Ω–∏–µ —Å–∫—Ä–∏–ø—Ç–∞:</label>
      <input type="text" id="scriptName" placeholder="–Ω–∞–ø—Ä–∏–º–µ—Ä, —Å–∫—Ä–∏–ø—Ç 1">

      <label for="scriptName">ID —Å–∫—Ä–∏–ø—Ç–∞:</label>
      <input type="number" id="scriptId" placeholder="–Ω–∞–ø—Ä–∏–º–µ—Ä, 5"/>

      <table style="margin-top:10px" id="scriptTable">
        <thead>
        <tr>
          <th style="width:80px">–¢–∏–ø</th>
          <th colspan="2">–ó–Ω–∞—á–µ–Ω–∏–µ</th>
          <th style="width:160px" colspan="3"></th>
        </tr>
        </thead>
        <tbody></tbody>
      </table>
      <button onclick="addScriptLine()">+ –î–æ–±–∞–≤–∏—Ç—å —Å—Ç—Ä–æ–∫—É</button>
      <button onclick="saveScript()">‚úî –°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Å–∫—Ä–∏–ø—Ç</button>
    </div>
  </div>
</div>

<script>
  let buttonsConfig = [];
  let layerCount = 0;
  let irCodes = [];
  let availableActions = [];
  let scriptList = [];
  let scriptCode = []

  const freqList = [17, 22, 24, 36, 38, 44, 48];
  const mouseCodes = [
    ["–ù–µ—Ç", 0],
    ["MOUSE_LEFT", 1],
    ["MOUSE_RIGHT", 2],
    ["MOUSE_MIDDLE", 4],
    ["MOUSE_BACK", 8],
    ["MOUSE_FORWARD", 16]
  ];

  let keyboardCodes = [];
  let mediaCodes = [];

  const actionTypes = ["click", "double", 'release', "hold", "holdRepeat", "holdRelease", "oneClickHold"];
  // title, value, has custom, show (0 - all, 1 - script, 2 - default), –Ω–∞–ª–∏—á–∏–µ 2-–≥–æ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞
  const targetTypes = [
    ["–ù–ï–¢", 0, false, 2, false],
    ["–ó–∞–¥–µ—Ä–∂–∫–∞", 0, false, 1, false],
    ["–ö–ª–∞–≤–∏–∞—Ç—É—Ä–∞", 1, true, 0, true],
    ["–ú–µ–¥–∏–∞", 10, false, 0, false],
    ["–ú—ã—à—å –∫–ª–∏–∫", 2, true, 0, true],
    ["–ú—ã—à—å –¥–≤–∏–∂–µ–Ω–∏–µ", 7, false, 0, true],
    ["–°–ª–æ–π", 5, false, 0, false],
    ["IR", 4, false, 0, false],
    ["–§—É–Ω–∫—Ü–∏—è", 6, false, 0, false],
    ["–°–∫—Ä–∏–ø—Ç", 9, false, 2, false]
  ];
  let actionSelected = ['click'];

  const isMockMode = location.hostname === 'localhost';

  async function apiFetch(url, options = {}) {
    if (isMockMode && options.method !== 'POST') {
      return fetch('/mock' + url.replace('/api', '') + '.json');
    }
    return fetch(url, options);
  }

  function alert_message(msg) {
    const root_el = document.getElementById('msg_wrapper')
    const msg_el = document.createElement('div');
    msg_el.innerText = msg;
    msg_el.className = 'alert_message';

    root_el.appendChild(msg_el)
    setTimeout(() => {
      root_el.removeChild(msg_el);
    }, 3000);
  }

  ///////////////////////// LAYOUT /////////////////////////

  let layoutTextBackup = '';
  let layoutData = [];

  function showLayoutEditor() {
    layoutTextBackup = document.getElementById('layoutText').value;
    document.getElementById('layoutEditor').classList.add('active');
    document.getElementById('layoutPreview').classList.add('hidden');
    document.getElementsByClassName('layout-edit-btn')[0].style.display = 'none';
    document.getElementById('layoutText').focus();
  }

  function cancelLayout() {
    document.getElementById('layoutEditor').classList.remove('active');
    document.getElementById('layoutPreview').classList.remove('hidden');
    document.getElementsByClassName('layout-edit-btn')[0].style.display = 'block';
    document.getElementById('layoutText').value = layoutTextBackup;
  }

  function saveLayout(apply = false) {
    const value = document.getElementById('layoutText').value;
    apiFetch('/api/layout', {
      method: 'POST',
      headers: {'Content-Type': 'application/x-www-form-urlencoded'},
      body: encodeURIComponent(value)
    }).then(() => {
      if (apply) {
        renderLayout();
      }
      document.getElementById('layoutEditor').classList.remove('active');
      document.getElementById('layoutPreview').classList.remove('hidden');
      document.getElementsByClassName('layout-edit-btn')[0].style.display = 'block';
      alert_message('–°—Ö–µ–º–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞');
    });
  }

  function renderLayout() {
    const container = document.getElementById('layoutPreview');
    container.innerHTML = '';
    const lines = document.getElementById('layoutText').value.trim().split('\n');
    layoutData = [];

    for (let i = 0; i < lines.length; i++) {
      const parts = lines[i].split(':');
      if (parts.length < 7) continue;

      const [x, y, type, w, h, key, color] = parts;
      const div = document.createElement('div');
      div.classList.add('layout-element');
      div.dataset.index = i;
      div.dataset.key = key;
      div.style.left = `${parseInt(x)}px`;
      div.style.top = `${parseInt(y)}px`;
      div.style.width = `${parseInt(w)}px`;
      div.style.height = `${parseInt(h)}px`;
      div.style.borderRadius = type === '–∫—Ä—É–≥' ? '50%' : '5px';
      div.style.border = '1px solid #333';

      let finalColor = color || '#ccc';
      if (key !== 'none' && !isNaN(parseInt(key))) {
        const k = parseInt(key);
        const currentLayer = parseInt(document.getElementById('layerSelect').value);
        const button = buttonsConfig[currentLayer]?.[k];
        if (button && button.color) {
          finalColor = typeof button.color === 'string' && button.color.startsWith('#')
            ? button.color
            : '#' + ('000000' + button.color.toString(16)).slice(-6);
        }

        div.onmouseenter = () => highlightTableRow(key, true);
        div.onmouseleave = () => highlightTableRow(key, false);
        div.onclick = () => {
          document.querySelector('input[type="checkbox"].btnCheckbox[btnIndex="' + key + '"]').click()
        };

        div.classList.add('layout-button');

        const label = document.createElement('div');
        label.innerText = key;
        label.style.color = '#000';
        label.style.fontSize = '12px';
        label.style.textAlign = 'center';
        label.style.lineHeight = `${parseInt(h)}px`;
        label.style.pointerEvents = 'none';
        div.appendChild(label);
      }

      div.style.background = finalColor;

      container.appendChild(div);
      layoutData.push({x, y, w, h, key});
    }
  }

  function highlightTableRow(key, highlight) {
    const rows = document.querySelectorAll('#buttonsTableContainer table tr');
    rows.forEach(row => {
      if (row.firstChild && row.firstChild.innerText == key) {
        row.style.backgroundColor = highlight ? '#ffeeba' : '';
      }
    });

    const elements = document.querySelectorAll('#layoutPreview .layout-button');
    elements.forEach(el => {
      if (el.dataset.key == key) {
        el.style.outline = highlight ? '3px solid red' : '';
      }
    });
  }

  async function loadLayout() {
    try {
      const layoutRes = await apiFetch('/api/layout');
      const layoutText = await layoutRes.text();
      document.getElementById('layoutText').value = layoutText;
      renderLayout();
      document.getElementById('layoutText').addEventListener('input', renderLayout);
    } catch (e) {
      console.warn("–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å layout");
    }
  }

  function updateLayoutButtonColor(layer, btnIndex, color) {
    const layoutButtons = document.querySelectorAll('.layout-button');
    layoutButtons.forEach(btn => {
      if (btn.dataset.key === String(btnIndex)) {
        btn.style.backgroundColor = color;
      }
    });
  }

  //////////////////////// LAYOUT end ////////////////////////


  //////////////////////// SCRIPTS ////////////////////////
  async function fetchScriptsList() {
    const res = await apiFetch('/api/scripts');
    // get text from response
    const text = await res.text();
    scriptList = JSON.parse(text.replace('\n', '').replace('\r', ''));
    const select = document.getElementById('scriptList');
    select.innerHTML = '<option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ —Å–∫—Ä–∏–ø—Ç --</option>';
    scriptList.forEach(script => {
      const opt = document.createElement('option');
      opt.value = script.id;
      opt.innerText = script.name + ' (' + script.id + ')';
      select.appendChild(opt);
    });
  }

  function renderScriptTable() {
    const tbody = document.querySelector('#scriptTable tbody');
    tbody.innerHTML = '';
    for (const index in scriptCode) {
      let line_index = parseInt(index);
      const line = scriptCode[line_index];
      const tr = document.createElement('tr');
      for (const el of getControl(line, true)) {
        tr.appendChild(el);
      }

      const upTd = document.createElement('td');
      const upBtn = document.createElement('button');
      upBtn.innerHTML = '&#8593;';
      upBtn.onclick = () => {
        if (line_index > 0) {
          const prevLine = scriptCode[line_index - 1];
          scriptCode[line_index - 1] = line;
          scriptCode[line_index] = prevLine;
          renderScriptTable();
        }
      }
      upBtn.disabled = line_index === 0;
      upTd.appendChild(upBtn);
      tr.appendChild(upTd);

      const downTd = document.createElement('td');
      const downBtn = document.createElement('button');
      downBtn.innerHTML = '&#8595;';
      downBtn.onclick = () => {
        if (line_index < scriptCode.length - 1) {
          const nextLine = scriptCode[line_index + 1];
          scriptCode[line_index + 1] = line;
          scriptCode[line_index] = nextLine;
          renderScriptTable();
        }
      }
      downBtn.disabled = line_index === scriptCode.length - 1;
      downTd.appendChild(downBtn);
      tr.appendChild(downTd);

      const delTd = document.createElement('td');
      const delBtn = document.createElement('button');
      delBtn.innerHTML = '&#10006;';
      delBtn.onclick = () => {
        const index = Array.from(tbody.children).indexOf(tr);
        scriptCode.splice(index, 1);
        tr.remove();
      }
      delTd.appendChild(delBtn);
      tr.appendChild(delTd);

      tbody.appendChild(tr);
    }
  }

  function addScriptLine() {
    scriptCode = scriptCode || [];
    scriptCode.push({type: 0, code: 0});
    renderScriptTable();
  }


  async function loadScriptEditor() {
    const name = document.getElementById('scriptList').value;
    if (!name) return;
    const res = await apiFetch('/api/scripts/download/' + name);
    const raw = await res.json();
    document.getElementById('scriptName').value = raw.name;
    document.getElementById('scriptId').value = raw.file.split('.')[0];
    scriptCode = raw.actions;
    renderScriptTable();
  }

  async function saveScript() {
    const name = document.getElementById('scriptName').value.trim();
    const id = parseInt(document.getElementById('scriptId').value.trim());
    const body = [];
    for (const line of scriptCode) {
      const type = parseInt(line.type);
      const code = parseInt(line.code);
      const sub_code = parseInt(line.sub_code) || 0;

      body.push(type + ':' + code + ':' + sub_code);
    }
    if (!name || !body || !id) return alert_message('–í–≤–µ–¥–∏—Ç–µ –∏–º—è –∏ —Å—Ç—Ä–æ–∫–∏ —Å–∫—Ä–∏–ø—Ç–∞');
    const res = await apiFetch('/api/scripts/upload', {
      method: 'POST',
      headers: {'Content-Type': 'application/x-www-form-urlencoded'},
      body: `name=${encodeURIComponent(name)}&id=${id}&body=${encodeURIComponent(body.join(';'))}`
    });
    if (res.ok) {
      alert_message('–°–∫—Ä–∏–ø—Ç —Å–æ—Ö—Ä–∞–Ω—ë–Ω');
      fetchScriptsList();
    } else {
      alert_message('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Å–∫—Ä–∏–ø—Ç–∞');
    }
  }

  async function deleteScript() {
    const name = document.getElementById('scriptList').value;
    if (!name) return;
    if (!confirm('–£–¥–∞–ª–∏—Ç—å —Å–∫—Ä–∏–ø—Ç ' + name + '?')) return;
    const res = await apiFetch('/api/scripts/delete', {
      method: 'POST',
      headers: {'Content-Type': 'application/x-www-form-urlencoded'},
      body: `name=${encodeURIComponent(name)}`
    });
    if (res.ok) {
      alert_message('–£–¥–∞–ª–µ–Ω–æ');
      fetchScriptsList();
    } else {
      alert_message('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è');
    }
  }

  function downloadScript() {
    const name = document.getElementById('scriptList').value;
    if (!name) return;
    window.open('/api/scripts/download/' + name, '_blank');
  }

  //////////////////////// SCRIPTS end ////////////////////////

  async function loadWiFi() {
    const res = await apiFetch('/api/wifi');
    const data = await res.json();
    document.getElementById('ssid').value = data.ssid;
    document.getElementById('password').value = data.password;
    document.getElementById('mode').value = data.mode ? 1 : 0;
  }

  async function loadIRCodes() {
    const res = await apiFetch('/api/ir/list');
    irCodes = await res.json();
    renderIRCodes();
  }

  function item_rang(count, prefix) {
    const arr = [];
    for (let i = 0; i < count; i++) {
      arr.push([prefix + (i + 1), i, null]);
    }
    return arr;
  }

  // function getSelectEl(options, selectedValue, reverse = false, has_custom = false) {
  function getControl(selectedValue, isScript = false) {
    const out_el_list = []

    const actionTypeSelect = document.createElement('td');
    const select = document.createElement('select');
    let targetTypesDict = {}
    targetTypes.forEach((item) => {
      const [label, i, has_custom, display, second_input] = item;
      const option = document.createElement('option');
      if (isScript && display === 2) {
        return
      }
      if (!isScript && display === 1) {
        return
      }
      targetTypesDict[i] = item
      option.value = i;
      option.innerText = label;
      if (selectedValue.type === i) {
        option.selected = true;
      }
      select.appendChild(option);
    });
    actionTypeSelect.appendChild(select);
    out_el_list.push(actionTypeSelect);

    const codeSelect = document.createElement('td');
    out_el_list.push(codeSelect);

    const select_el = document.createElement('select');
    const input_el = document.createElement('input');
    codeSelect.appendChild(select_el);
    codeSelect.appendChild(input_el);
    input_el.type = 'number';
    input_el.onchange = () => {
      selectedValue.code = parseInt(input_el.value);
    };

    const customTd = document.createElement('td');
    out_el_list.push(customTd);
    const customInput = document.createElement('input');
    customInput.type = 'number';
    customInput.style.display = 'none';
    customTd.appendChild(customInput)
    customInput.onchange = () => {
      if (targetTypesDict[selectedValue.type][4]) {
        selectedValue.sub_code = parseInt(customInput.value);
      } else {
        selectedValue.code = parseInt(customInput.value);
      }
    };

    select_el.onchange = () => {
      if (targetTypesDict[selectedValue.type][2]) { // –Ω–∞–ª–∏—á–∏–µ –∫–∞—Å—Ç–æ–º–Ω–æ–≥–æ –≤–∞—Ä–∏–∞–Ω—Ç–∞. –ö–ª–∞–≤–∏–∞—Ç—É—Ä–∞ –∏–ª–∏ –º—ã—à—å
        selectedValue.sel = select_el.value;
        if (selectedValue.sel === 'custom') {
          customInput.style.display = 'inline-block';
          customInput.value = selectedValue.code;
        } else {
          selectedValue.code = parseInt(select_el.value);
          customInput.style.display = 'none';
        }
      } else {
        selectedValue.code = parseInt(select_el.value);
      }
    };

    const options_lists = {
      1: keyboardCodes.map((item) => [item.name, item.id, item.group]),
      2: mouseCodes.map((item) => [...item, null]),
      4: irCodes.map((item) => [`${item.name} (${item.slot})`, item.slot, null]),
      5: item_rang(info.layers, 'Layer #'),
      6: availableActions.map((item) => [item.name, item.id, null]),
      9: scriptList.map((item) => [parseInt(item.id.split('.')[0]) + ': ' + item.name, parseInt(item.id.split('.')[0]), null]),
      10: mediaCodes.map((item) => [item.name, item.id, null]),
    }

    select.onchange = () => {
      selectedValue.type = parseInt(select.value);
      if (selectedValue.type === 0 && !isScript) {
        input_el.style.display = 'none';
        select_el.style.display = 'none';
        customInput.style.display = 'none';
      } else if (options_lists[selectedValue.type] !== undefined) {
        select_el.style.display = 'inline-block';
        input_el.style.display = 'none';
        customInput.style.display = 'none';

        const options = options_lists[selectedValue.type] || []

        select_el.innerText = '';
        let current_group = null
        let group_root = null
        for (let [text, val, group] of options) {
          if (current_group !== group) {
            current_group = group
            if (current_group !== null) {
              group_root = document.createElement('optgroup');
              group_root.label = group;
              group_root.innerText = group;
              select_el.appendChild(group_root);
            } else {
              group_root = null
            }
          }
          const option = document.createElement('option');
          option.value = val;
          option.innerText = text;
          if (group_root !== null) {
            group_root.appendChild(option);
          } else {
            select_el.appendChild(option);
          }
        }
        if (targetTypesDict[selectedValue.type][2]) {
          const customOption = document.createElement('option');
          customOption.value = 'custom';
          customOption.innerText = '–ö–∞—Å—Ç–æ–º–Ω—ã–π';
          if (selectedValue.sel === 'custom') {
            customOption.selected = true;
          }
          select_el.appendChild(customOption);
          const pr_sel = selectedValue.sel
          selectedValue.sel = findCode(selectedValue.code, options);
          select_el.value = selectedValue.sel;
          select_el.onchange()
        }
      } else {
        select_el.style.display = 'none';
        customInput.style.display = targetTypesDict[selectedValue.type][4] ? 'inline-block' : 'none';
        if (targetTypesDict[selectedValue.type][4]) {
          customInput.value = selectedValue.sub_code
        }
        input_el.value = selectedValue.code
        input_el.style.display = 'inline-block';
      }
    };

    select.onchange()
    return out_el_list;
  }

  function findCode(code, options, reverse = false) {
    for (let [key, value] of options) {
      if (reverse) {
        if (key === code) {
          return key;
        }
      } else {
        if (value === code) {
          return value;
        }
      }
    }
    return 'custom';
  }

  function renderButtonConfig() {
    const container = document.getElementById('buttonsTableContainer');
    const layer = parseInt(document.getElementById('layerSelect').value);
    container.innerHTML = '';
    const table = document.createElement('table');
    const header = document.createElement('tr');
    header.className = 'btnHeader';
    const columns = [
      {name: 'btnIndex', title: '#'},
      {name: 'checkbox', title: ''},
      {name: 'color', title: '–¶–≤–µ—Ç'},
      {name: 'action', title: '–î–µ–π—Å—Ç–≤–∏–µ'},
      {name: 'type', title: '–¢–∏–ø'},
      {name: 'code', title: '–ö–æ–¥', colspan: 2},
    ]
    const checkboxAll = document.createElement('input');
    for (const col of columns) {
      const th = document.createElement('th');
      th.innerText = col.title;
      if (col.colspan) {
        th.setAttribute('colspan', col.colspan);
      }
      if (col.name === 'checkbox') {
        checkboxAll.type = 'checkbox';
        checkboxAll.className = 'btnCheckbox all';
        checkboxAll.onchange = () => {
          const checkboxes = document.querySelectorAll('.btnCheckbox');
          checkboxes.forEach((el) => {
            if (el.classList.contains('all')) return;
            el.checked = checkboxAll.checked;
          });
        };
        th.appendChild(checkboxAll);
      }
      if (col.name === 'color') {
        const colorInput = document.createElement('input');
        colorInput.type = 'color';
        colorInput.value = '#ffffff';
        colorInput.setAttribute('list', 'color_list');
        colorInput.onchange = () => {
          const checkboxes = document.querySelectorAll('.btnCheckbox');
          checkboxes.forEach((el) => {
            if (el.classList.contains('all')) return;
            if (el.checked) {
              const btn_el = el.closest('tr').querySelector('.btnIndex');
              if (!btn_el) return;
              const btnIndex = parseInt(btn_el.innerText);
              buttonsConfig[layer][btnIndex].color = colorInput.value;
              updateLayoutButtonColor(layer, btnIndex, colorInput.value);
              const color = document.querySelector(`input[btnIndex="${btnIndex}"][type="color"]`);
              if (color) {
                color.value = colorInput.value;
              }

            }
          });
        };
        th.appendChild(colorInput);
      }
      header.appendChild(th);
    }
    table.appendChild(header);

    buttonsConfig[layer].forEach((btnObj, idx) => {
      let tr = document.createElement('tr');
      const td = document.createElement('td');
      const actionSel = actionSelected.length ? actionSelected : actionTypes
      td.innerText = idx;
      td.setAttribute('rowspan', actionSel.length);
      td.className = 'btnIndex';
      tr.appendChild(td);

      const checkboxTd = document.createElement('td');
      checkboxTd.style.textAlign = 'center';
      const checkbox = document.createElement('input');
      checkbox.type = 'checkbox';
      checkbox.className = 'btnCheckbox';
      checkbox.setAttribute('btnIndex', idx);
      checkbox.onchange = () => {
        const checkboxes = document.querySelectorAll('.btnCheckbox:not(.all)');
        const allChecked = Array.from(checkboxes).every((el) => el.checked);
        const allUnchecked = Array.from(checkboxes).every((el) => !el.checked);
        checkboxAll.checked = allChecked;
        checkboxAll.indeterminate = !allChecked && !allUnchecked;
      };
      checkboxTd.appendChild(checkbox);
      tr.appendChild(checkboxTd);

      const colorTd = document.createElement('td');
      colorTd.setAttribute('rowspan', actionSel.length);
      const colorInput = document.createElement('input');
      colorInput.type = 'color';
      colorInput.value = typeof (btnObj.color) == 'string' && btnObj.color[0] === '#' ? btnObj.color : '#' + ('00000' + (btnObj.color || 0).toString(16)).slice(-6);
      colorInput.setAttribute('list', 'color_list');
      colorInput.setAttribute('btnIndex', idx);
      colorInput.onchange = () => {
        btnObj.color = colorInput.value;
        updateLayoutButtonColor(layer, idx, btnObj.color);
      };
      colorTd.appendChild(colorInput);
      tr.appendChild(colorTd);


      for (const action of actionSel) {
        const actionType = document.createElement('td');
        actionType.innerText = action;
        actionType.className = 'btnToDo';
        tr.appendChild(actionType);

        const b = btnObj[action];
        for (const el of getControl(b)) {
          tr.appendChild(el);
        }
        table.appendChild(tr);
        tr = document.createElement('tr');
      }
    });
    container.appendChild(table);
    renderLayout();
  }

  async function loadButtons() {
    const res = await apiFetch('/api/buttons');
    buttonsConfig = await res.json();
    layerCount = buttonsConfig.length;
    const sel = document.getElementById('layerSelect');
    sel.innerHTML = '';
    for (let i = 0; i < layerCount; i++) {
      const opt = document.createElement('option');
      opt.value = i;
      opt.innerText = '–°–ª–æ–π ' + i;
      sel.appendChild(opt);
    }

    actionSelect = document.getElementById('actionSelect');
    actionSelect.innerHTML = '';
    for (const action of actionTypes) {
      const label = document.createElement('label');
      const span = document.createElement('span');
      span.innerText = action;
      const checkbox = document.createElement('input');
      checkbox.type = 'checkbox';
      checkbox.checked = actionSelected.includes(action);
      checkbox.onchange = () => {
        if (checkbox.checked) {
          actionSelected.push(action);
        } else {
          actionSelected = actionSelected.filter(a => a !== action);
        }
        renderButtonConfig();
      };
      label.appendChild(checkbox);
      label.appendChild(span);
      actionSelect.appendChild(label);
    }

    setTimeout(renderButtonConfig, 100);
  }

  function ir_capture(ir) {
    let data = {
      freq: ir.freq,
      timeout: 5000,
      name: ir.name,
    }
    if (ir.slot !== "" && ir.slot !== undefined) {
      data.slot = ir.slot;
    }
    apiFetch('/api/ir/capture', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify(data)
    }).then(res => {
      if (res.ok) {
        captureInterval = setInterval(() => {
          apiFetch('/api/ir/status').then(res => {
            if (res.ok) {
              res.json().then(data => {
                if (data.status === "captured") {
                  ir.slot = data.slot;
                  ir.freq = data.freq;
                  ir.name = data.name;
                  ir.raw = data.raw;
                  clearInterval(captureInterval)
                  renderIRCodes();
                  alert_message('IR-–∫–æ–¥ —Å—á–∏—Ç–∞–Ω');
                } else if (data.status === "timeout") {
                  clearInterval(captureInterval)
                  alert_message('–í—Ä–µ–º—è –æ–∂–∏–¥–∞–Ω–∏—è –∏—Å—Ç–µ–∫–ª–æ');
                } else if (data.status === "no_empty_slots") {
                  clearInterval(captureInterval)
                  alert_message('–ù–µ—Ç —Å–≤–æ–±–æ–¥–Ω—ã—Ö —Å–ª–æ—Ç–æ–≤');
                } else if (data.status === "error") {
                  clearInterval(captureInterval)
                  alert_message('–û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è IR-–∫–æ–¥–∞');
                }
              });
            }
          });
        }, 1000);
      } else {
        alert_message('–û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è IR-–∫–æ–¥–∞');
      }
    });
  }

  function ir_send(ir) {
    if (ir.slot === "" || ir.slot === undefined) {
      return
    }
    apiFetch('/api/ir/send', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: ir.slot
    }).then(res => {
      if (res.ok) {
        alert_message('IR-–∫–æ–¥ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω');
      } else {
        alert_message('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ IR-–∫–æ–¥–∞');
      }
    });
  }

  function renderIRCodes() {
    const tbody = document.querySelector('#irTable tbody');
    tbody.innerHTML = '';
    irCodes.forEach((ir, i) => {
      let captureInterval = null;
      const tr = document.createElement('tr');
      const slotTdIndex = document.createElement('td');
      slotTdIndex.innerText = i + 1;
      tr.appendChild(slotTdIndex);

      const slotTd = document.createElement('td');
      slotTd.innerText = ir.slot;
      tr.appendChild(slotTd);

      const nameTd = document.createElement('td');
      const nameInput = document.createElement('input');
      nameInput.type = 'text';
      nameInput.value = ir.name;
      nameInput.onchange = () => {
        ir.name = nameInput.value;
      };
      nameTd.appendChild(nameInput);
      tr.appendChild(nameTd);

      const freqTd = document.createElement('td');
      const freqInput = document.createElement('select');
      for (const freq of freqList) {
        const option = document.createElement('option');
        option.value = freq;
        option.innerText = freq;
        if (ir.freq === freq) {
          option.selected = true;
        }
        freqInput.appendChild(option);
      }
      freqInput.onchange = () => {
        ir.freq = parseInt(freqInput.value);
      };
      freqTd.appendChild(freqInput);
      tr.appendChild(freqTd);

      const rawTd = document.createElement('td');
      const rawInput = document.createElement('input');
      rawInput.type = 'text';
      rawInput.value = ir.raw;
      rawInput.onchange = () => {
        ir.raw = rawInput.value;
      };
      rawTd.appendChild(rawInput);
      tr.appendChild(rawTd);


      const readTd = document.createElement('td');
      const readButton = document.createElement('button');
      readButton.innerText = '–°—á–∏—Ç–∞—Ç—å';
      readButton.onclick = () => {
        ir_capture(ir);
      }
      readTd.appendChild(readButton);
      tr.appendChild(readTd);

      const delTd = document.createElement('td');
      const delButton = document.createElement('button');
      delButton.innerText = '–£–¥–∞–ª–∏—Ç—å';
      delButton.onclick = () => {
        removeIRCode(i);
      };
      if (ir.slot !== "" && ir.slot !== undefined) {
        delTd.appendChild(delButton);
      }
      tr.appendChild(delTd);

      // /api/ir/send send if has slot
      const sendTd = document.createElement('td');
      const sendButton = document.createElement('button');
      sendButton.innerText = '–û—Ç–ø—Ä–∞–≤–∏—Ç—å';
      sendButton.onclick = () => {
        ir_send(ir);
      };
      if (ir.slot !== "" && ir.slot !== undefined) {
        sendTd.appendChild(sendButton);
      }
      tr.appendChild(sendTd);

      // "/api/ir/download/*", HTTP_GET
      const downloadTd = document.createElement('td');
      const downloadButton = document.createElement('button');
      downloadButton.innerText = '–°–∫–∞—á–∞—Ç—å';
      downloadButton.onclick = () => {
        const a = document.createElement('a');
        a.href = '/api/ir/download/' + ir.slot;
        a.download = ir.slot;
        a.click();
      };
      if (ir.slot !== "" && ir.slot !== undefined) {
        downloadTd.appendChild(downloadButton);
      }
      tr.appendChild(downloadTd);

      tbody.appendChild(tr)
    });
  }

  function addIRCode() {
    irCodes.push({slot: "", name: "", freq: 38, raw: ""});
    renderIRCodes();
  }

  function removeIRCode(index) {
    apiFetch('/api/ir/delete', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: irCodes[index].slot
    }).then(res => {
      if (res.ok) {
        irCodes.splice(index, 1);
        renderIRCodes();
      } else {
        alert_message('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è IR-–∫–æ–¥–∞');
      }
    });
  }

  async function saveWiFi() {
    const ssid = document.getElementById('ssid').value;
    const password = document.getElementById('password').value;
    const mode = document.getElementById('mode').value;
    await apiFetch('/api/wifi', {
      method: 'POST',
      headers: {'Content-Type': 'application/x-www-form-urlencoded'},
      body: `ssid=${ssid}&password=${password}&mode=${mode}`
    });
    alert_message("Wi-Fi —Å–æ—Ö—Ä–∞–Ω—ë–Ω. –£—Å—Ç—Ä–æ–π—Å—Ç–≤–æ –±—É–¥–µ—Ç –ø–µ—Ä–µ–∑–∞–ø—É—â–µ–Ω–æ.");
  }

  async function saveButtons() {
    // data json to key:<layout>:<bnt id>;color:#ff0000;click:<type>:<code>;double:<type>:<code>|key:<layout>:<bnt id>;color:#ff0000;click:<type>:<code>
    const data = {};
    buttonsConfig.forEach((layer, i) => {
      layer.forEach((btn, j) => {
        const key = `${i}:${j}`;
        // convert hex color to int
        const color = typeof btn.color == 'string' && btn.color[0] === '#' ? parseInt(btn.color.replace('#', ''), 16) : btn.color;
        data[key] = {color};
        actionSelected.forEach(action => {
          if (btn[action]) {
            data[key][action] = btn[action].type + ':' + btn[action].code + ':' + (btn[action].sub_code || 0);
          }
        });
      });
    });
    const out_data = Object.entries(data).map(([key, value]) => {
      return ['key:' + key].concat(Object.entries(value).map(([k, v]) => `${k}:${v}`)).join(';');
    }).join('|');
    apiFetch('/api/buttons', {
      method: 'POST',
      headers: {'Content-Type': 'application/x-www-form-urlencoded'},
      body: out_data
    }).then(res => {
      if (res.ok) {
        alert_message("–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –∫–Ω–æ–ø–æ–∫ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞.");
      } else {
        alert_message("–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –∫–Ω–æ–ø–æ–∫.");
      }
    }).catch(err => {
      console.error(err);
      alert_message("–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –∫–Ω–æ–ø–æ–∫.");
    });
  }

  async function loadInfo() {
    const res = await apiFetch('/api/info');
    if (!res.ok) {
      alert_message('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏');
      return;
    }
    info = await res.json();
    const infoDiv = document.getElementById('infoContent');

    let html = '';

    // –ì—Ä—É–ø–ø–∞: –°–∏—Å—Ç–µ–º–∞
    html += '<h3>–°–∏—Å—Ç–µ–º–∞</h3><table>';
    html += `<tr><td>–ß–∏–ø</td><td>${info.chip}</td></tr>`;
    if (info.chip !== info.chip_model) {
      html += `<tr><td>–ú–æ–¥–µ–ª—å —á–∏–ø–∞</td><td>${info.chip_model}</td></tr>`;
    }
    html += `<tr><td>–ü–∞–∫–µ—Ç</td><td>${info.chip_package || '-'}</td></tr>`;
    html += `<tr><td>–Ø–¥–µ—Ä</td><td>${info.cores}</td></tr>`;
    html += `<tr><td>–†–µ–≤–∏–∑–∏—è</td><td>${info.revision}</td></tr>`;
    html += `<tr><td>SDK –≤–µ—Ä—Å–∏—è</td><td>${info.sdk_version}</td></tr>`;
    html += `<tr><td>–°–±–æ—Ä–∫–∞</td><td>${info.build}</td></tr>`;
    html += `<tr><td>–ü—Ä–æ—à–∏–≤–∫–∞</td><td>${info.firmware_version || '-'}</td></tr>`;
    html += '</table>';

    // –ì—Ä—É–ø–ø–∞: –ü–∞–º—è—Ç—å
    html += '<h3>–ü–∞–º—è—Ç—å</h3><table>';
    html += `<tr><td>Heap –≤—Å–µ–≥–æ</td><td>${info.heap_total} –±–∞–π—Ç</td></tr>`;
    html += `<tr><td>Heap —Å–≤–æ–±–æ–¥–Ω–æ</td><td>${info.heap_free} –±–∞–π—Ç</td></tr>`;
    html += `<tr><td>–†–∞–∑–º–µ—Ä —Å–∫–µ—Ç—á–∞</td><td>${info.sketch_size} –±–∞–π—Ç</td></tr>`;
    html += `<tr><td>–°–≤–æ–±–æ–¥–Ω–æ –ø–æ–¥ —Å–∫–µ—Ç—á</td><td>${info.sketch_free_space} –±–∞–π—Ç</td></tr>`;
    html += `<tr><td>Flash —Ä–∞–∑–º–µ—Ä</td><td>${info.flash_size} KB</td></tr>`;
    html += `<tr><td>Flash —Å–∫–æ—Ä–æ—Å—Ç—å</td><td>${info.flash_speed} –ì—Ü</td></tr>`;
    html += '</table>';

    // –ì—Ä—É–ø–ø–∞: –ö–Ω–æ–ø–∫–∏ –∏ MCP
    html += '<h3>–ö–Ω–æ–ø–∫–∏ –∏ MCP</h3><table>';
    html += `<tr><td>–°–ª–æ–∏</td><td>${info.layers}</td></tr>`;
    html += `<tr><td>–ö–Ω–æ–ø–∫–∏</td><td>${info.keys_count}</td></tr>`;
    html += `<tr><td>–ß–∏–ø—ã MCP23017</td><td>${info.mcp23017_count}</td></tr>`;
    html += `<tr><td>MCP init</td><td>${Object.entries(info.mcp23017_init).map(([k, v]) => `ID ${k}: ${v ? 'OK' : '–û—à–∏–±–∫–∞'}`).join('<br>')}</td></tr>`;
    html += '</table>';

    // –ë–ª–æ–∫: –î–µ—Ç–∞–ª–∏–∑–∞—Ü–∏—è –∫–Ω–æ–ø–æ–∫
    html += '<h3>–î–µ—Ç–∞–ª–∏ –∫–Ω–æ–ø–æ–∫</h3><table>';
    html += '<tr><th>Index</th><th>Source</th><th>Source index</th><th>Side</th><th>Code</th><th>LED index</th><th>–¢–µ—Å—Ç</th></tr>';
    const sourceLabels = {0: 'MCP', 1: 'GPIO'};
    const sideLabels = {0: 'KEYBOARD', 1: 'MOUSE', 2: 'BOTH'};
    info.keys_config.forEach(btn => {
      html += `<tr>
    <td>${btn.index}</td>
    <td>${sourceLabels[btn.source] || btn.source}</td>
    <td>${btn.source_index}</td>
    <td>${sideLabels[btn.side] || btn.side}</td>
    <td>${btn.code}</td>
    <td>${btn.led_index}</td>`;
      if (btn.led_index !== -1) {
        html += `<td><button onclick="testLed(${btn.led_index})">–û—Ç–ø—Ä–∞–≤–∏—Ç—å —Ç–µ—Å—Ç</button></td>`;
      } else {
        html += '<td></td>';
      }
      html += '</tr>';
    });
    html += '</table>';

    // –ì—Ä—É–ø–ø–∞: –°–µ—Ç—å
    html += '<h3>Wi-Fi</h3><table>';
    html += `<tr><td>SSID</td><td>${info.wifi_ssid || '-'}</td></tr>`;
    html += `<tr><td>IP</td><td>${info.wifi_ip || '-'}</td></tr>`;
    html += `<tr><td>MAC</td><td>${info.wifi_mac || '-'}</td></tr>`;
    html += `<tr><td>–£—Ä–æ–≤–µ–Ω—å —Å–∏–≥–Ω–∞–ª–∞</td><td>${info.wifi_signal_strength} dBm</td></tr>`;
    html += `<tr><td>–†–µ–∂–∏–º</td><td>${info.wifi_mode === 1 ? 'AP' : 'STA'}</td></tr>`;
    html += '</table>';

    // –ì—Ä—É–ø–ø–∞: LED
    html += '<h3>LED</h3><table>';
    html += `<tr><td>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ</td><td>${info.leds_count}</td></tr>`;
    html += `<tr><td>–Ø—Ä–∫–æ—Å—Ç—å</td><td>${info.leds_brightness}</td></tr>`;
    html += `<tr><td>–ò–Ω–¥–µ–∫—Å —Å—Ç–∞—Ç—É—Å–Ω–æ–≥–æ LED</td><td>${info.status_led_index === -1 ? '–Ω–µ—Ç' : info.status_led_index}</td></tr>`;
    html += '</table>';

    // –ì—Ä—É–ø–ø–∞: IR
    html += '<h3>IR</h3><table>';
    html += `<tr><td>–°–ª–æ—Ç–æ–≤ –¥–ª—è IR</td><td>${info.ir_slots}</td></tr>`;
    html += '</table>';

    // –ì—Ä—É–ø–ø–∞: –ü–æ–¥–¥–µ—Ä–∂–∫–∞
    html += '<h3>–ü–æ–¥–¥–µ—Ä–∂–∫–∞</h3><table>';
    for (const [feat, val] of Object.entries(info.features || {})) {
      html += `<tr><td>${feat}</td><td>${val ? '‚úî' : '‚úñ'}</td></tr>`;
    }
    html += '</table>';

    // –ü—Ä–æ–≤–µ—Ä–∫–∞ IP5306
    if (info.ip5306_available) {
      html += '<h3>–ü–∏—Ç–∞–Ω–∏–µ</h3><table>';
      html += `<tr><td>–£—Ä–æ–≤–µ–Ω—å –±–∞—Ç–∞—Ä–µ–∏</td><td>${info.battery_level}%</td></tr>`;
      html += `<tr><td>–ó–∞—Ä—è–∂–∞–ª—Å—è</td><td>${info.was_charging ? '–î–∞' : '–ù–µ—Ç'}</td></tr>`;
      html += `<tr><td>–ù—É–∂–Ω–∞ –∑–∞—Ä—è–¥–∫–∞</td><td>${info.needs_charge ? '–î–∞' : '–ù–µ—Ç'}</td></tr>`;
      html += `<tr><td>–î–∞–Ω–Ω—ã–µ –∑–∞—Ä—è–¥–∫–∏</td><td>${info.charging_data_available ? '–î–æ—Å—Ç—É–ø–Ω—ã' : '–ù–µ—Ç'}</td></tr>`;
      html += '</table>';
    }

    infoDiv.innerHTML = html;
  }

  function testLed(index) {
    const color = document.getElementById('colorInputColor').value;
    apiFetch('/api/led/set', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: `index=${index}&color=${color}`
    }).then(res => {
      if (res.ok) {
        alert_message(`–¶–≤–µ—Ç ${color} —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –Ω–∞ LED ${index}`);
      } else {
        alert_message('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ç–µ—Å—Ç–∞');
      }
    });
  }

  async function loadActions() {
    try {
      const res = await apiFetch('/api/actions');
      availableActions = await res.json();
    } catch (e) {
      availableActions = [];
    }
  }

  async function loadKeyboardCodes() {
    const res = await apiFetch('/api/keycodes');
    keyboardCodes = await res.json();
  }

  async function loadMediaCodes() {
    const res = await apiFetch('/api/media');
    mediaCodes = await res.json();
  }

  async function testColor() {
    const color = document.getElementById('colorInputColor').value;
    const btnIndex = document.getElementById('colorInput').value;
    await apiFetch('/api/led/set', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: `index=${btnIndex}&color=${color}`
    }).then(res => {
      if (res.ok) {
        alert_message('–¶–≤–µ—Ç —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω');
      } else {
        alert_message('–û—à–∏–±–∫–∞ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ —Ü–≤–µ—Ç–∞');
      }
    });
  }


  async function init() {
    setTimeout(async () => {
      await loadInfo();
      await loadWiFi();
      await loadActions();
      await loadButtons();
      await loadIRCodes();
      await loadLayout();
      await fetchScriptsList();
      await loadKeyboardCodes();
      await loadMediaCodes();
    }, 200);
  }

  window.addEventListener('DOMContentLoaded', init);
  // click h2 to toggle section
  window.addEventListener('click', (e) => {
    if (e.target.tagName === 'H2') {
      const section = e.target.parentElement;
      section.classList.toggle('open');
      const body = section.querySelector('.section_body');
      body.classList.toggle('open');
    }
  });
</script>

</body>

</html>